---
import Layout from "../../layouts/Layout.astro";
import { getAllBlog } from "../../lib/microcms";
import BlogFilter from "../../components/features/blog/BlogFilter.astro";
import ArticleCard from "../../components/shared/card/ArticleCard";
import PageTitle from "../../components/shared/page/PageTitle";
import "../../components/shared/card/article-card.css";
import "../../components/shared/page/page-title.css";

let blogs;
try {
  blogs = await getAllBlog();
} catch (error) {
  // 環境変数が設定されていない場合は空のデータを返す
  blogs = { contents: [], totalCount: 0, offset: 0, limit: 0 };
}


const categories = [
  { id: "all", label: "All" },
  { id: "Programming", label: "Programming" },
  { id: "Coffee", label: "Coffee" },
  { id: "Design", label: "Design" },
  { id: "DailyLife", label: "Daily Life" }
];

---

<Layout title="Blog">
  <div class="blog-page">
    <PageTitle title="BLOG" pageType="blog" client:load />
    <!-- Category Filter -->
    <BlogFilter categories={categories} />

    {
      blogs === null && (
        <p>
          記事の取得に失敗しました。環境変数やネットワークを確認してください。
        </p>
      )
    }
    {blogs && blogs.totalCount === 0 && <p>投稿はまだありません。</p>}
    {blogs && blogs.totalCount > 0 && (
      <>
        <div class="blog-grid">
          {blogs.contents.map((blog) => (
            <ArticleCard
              client:load
              title={blog.title}
              summary={blog.summary}
              publishedAt={blog.publishedAt}
              thumbnail={blog.thumbnail}
              slug={blog.slug}
              category={blog.category}
            />
          ))}
        </div>

        <!-- Pagination -->
        <div class="pagination-container">
          <button id="prev-page" class="pagination-btn" disabled>
            <svg width="20" height="20" viewBox="0 0 16 16" fill="none">
              <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            back
          </button>
          
          <div class="pagination-center">
            <!-- <div class="page-indicator">
              <span class="current-page" id="current-page">1</span>
              <span class="separator">/</span>
              <span class="total-pages" id="total-pages">1</span>
            </div> -->
            <div class="items-count">
              <span class="count-number" id="total-items">{blogs.totalCount}</span>
              <span class="count-label">articles</span>
            </div>
          </div>
          
          <button id="next-page" class="pagination-btn next-btn">
            next
            <svg width="20" height="20" viewBox="0 0 16 16" fill="none">
              <path d="M6 4L10 8L6 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      </>
    )}
  </div>
</Layout>

<style>
  .blog-page {
    max-width: 75rem;
    margin: 0 auto;
    margin-left: 5rem;
    padding: 0 1rem;

    /* background: #f8fafc; より落ち着いたグレー背景 */
    position: relative;
  }


  .blog-page h1 {
    color: var(--color-primary);
    margin-bottom: 2rem;
    text-align: center;
  }


  .blog-grid {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-top: 2rem;
    position: relative;
    z-index: 0;
    align-items: center;
    max-width: 62.5rem;
    margin-left: auto;
    margin-right: auto;
  }

  /* すべての画面サイズで縦並びレイアウト */
  @media (width <= 47.9375rem) {
    .blog-grid {
      gap: 1.5rem;
      max-width: 100%;
      padding: 0 1rem;
    }
  }

  /* Keyframe animations removed */


  .no-blogs-message {
    grid-column: 1 / -1;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 20rem;
  }

  .no-blogs-content {
    text-align: center;
    padding: 3rem 2rem;
    background: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgb(0 0 0 / 10%);
    border: 1px solid #e2e8f0;
  }

  .no-blogs-content h3 {
    color: var(--color-text-primary);
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0 0 1rem;
  }

  .no-blogs-content p {
    color: var(--color-muted);
    font-size: 1rem;
    margin: 0;
    line-height: 1.5;
  }

  /* All keyframe animations removed */

  /* Pagination Styles */
  .pagination-container {
    margin-top: 2rem;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    max-width: 70rem;
    gap: 3rem;
  }

  .pagination-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    flex: 1;
  }

  .page-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #fff;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px rgb(0 0 0 / 10%);
    border: 1px solid #e2e8f0;
  }

  .current-page {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-primary);
    min-width: 1.5rem;
    text-align: center;
  }

  .separator {
    font-size: 1.2rem;
    font-weight: 300;
    color: var(--color-muted);
  }

  .total-pages {
    font-size: 1.2rem;
    font-weight: 500;
    color: var(--color-muted);
    min-width: 1.5rem;
    text-align: center;
  }

  .items-count {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.9rem;
    color: var(--color-muted);
  }

  .count-number {
    font-size: 1.8rem;
    font-weight: 600;
    color: var(--color-primary);
    line-height: 1;
  }

  .count-label {
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-muted);
    text-transform: uppercase;
    letter-spacing: 0.0313rem;
  }


  .pagination-btn {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 0.8rem 1.5rem;
    background: none;
    border: none;
    color: var(--color-muted);
    font-size: 1.4rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    border-radius: 0.5rem;
  }

  .pagination-btn:disabled {
    opacity: 30%;
    cursor: not-allowed;
    transform: none;
  }

  .pagination-btn:disabled::after {
    display: none;
  }

  .pagination-btn:hover:not(:disabled) {
    color: var(--color-text-primary);
  }

  .next-btn {
    margin-left: 4rem;
  }


  /* タブレットサイズ */
  @media (width <= 64rem) {
    .blog-page {
      margin-left: 5rem;
    }
  }

  @media (width <= 48rem) {
    .blog-page {
      margin-left: 7rem;
    }
  }

  /* 小さなモバイルサイズ */
  @media (width <= 30rem) {
    .blog-page {
      margin-left: 3.5rem;
    }
  }

  /* 非常に小さなモバイルサイズ */
  @media (width <= 20rem) {
    .blog-page {
      margin-left: 2.5rem;
    }
  }

  @media (width <= 47.9375rem) {
    .pagination-container {
      display: none;
    }
  }
</style>

<script>

  // Pagination functionality
  class BlogPagination {
    itemsPerPage: number;
    currentPage: number;
    currentCategory: string;
    allBlogs: Element[];
    filteredBlogs: Element[];
    totalPages: number;
    isMobile: boolean;

    constructor() {
      this.itemsPerPage = 6;
      this.currentPage = 1;
      this.currentCategory = 'all';
      this.allBlogs = [];
      this.filteredBlogs = [];
      this.totalPages = 1;
      this.isMobile = window.innerWidth <= 767;
      
      this.init();
    }

    init(): void {
      // Get all blog cards
      this.allBlogs = Array.from(document.querySelectorAll('.blog-card'));
      this.filteredBlogs = [...this.allBlogs];
      
      // Calculate total pages
      this.totalPages = Math.ceil(this.filteredBlogs.length / this.itemsPerPage);
      
      // Initialize pagination
      this.updatePaginationUI();
      
      // Show all blogs on mobile, paginated on desktop
      if (this.isMobile) {
        this.showAllBlogs();
      } else {
        this.showPage(1);
      }
      
      // Add event listeners
      this.addEventListeners();
    }

    addEventListeners(): void {
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');
      
      if (prevBtn) prevBtn.addEventListener('click', () => this.previousPage());
      if (nextBtn) nextBtn.addEventListener('click', () => this.nextPage());
    }

    filterByCategory(categoryId: string): void {
      this.currentCategory = categoryId;
      this.currentPage = 1;
      
      // Filter blogs by category
      this.filteredBlogs = this.allBlogs.filter(blog => {
        const blogCategory = blog.getAttribute('data-category');
        return categoryId === 'all' || blogCategory === categoryId;
      });
      
      // Recalculate total pages
      this.totalPages = Math.ceil(this.filteredBlogs.length / this.itemsPerPage);
      
      // Update UI without animation
      this.updatePaginationUI();
      
      // Show all blogs on mobile, paginated on desktop
      if (this.isMobile) {
        this.showAllBlogs();
      } else {
        this.showPage(1);
      }
    }

    showPage(page: number): void {
      this.currentPage = page;
      
      // Hide all blogs first
      this.allBlogs.forEach(blog => {
        (blog as HTMLElement).style.display = 'none';
      });
      
      // Show blogs for current page
      const startIndex = (page - 1) * this.itemsPerPage;
      const endIndex = startIndex + this.itemsPerPage;
      
      this.filteredBlogs.slice(startIndex, endIndex).forEach(blog => {
        (blog as HTMLElement).style.display = 'block';
      });
      
      // Update pagination UI
      this.updatePaginationUI();
      
      // Show no blogs message if needed
      if (this.filteredBlogs.length === 0) {
        this.showNoBlogsMessage();
      } else {
        this.hideNoBlogsMessage();
      }
    }

    showAllBlogs(): void {
      // Hide all blogs first
      this.allBlogs.forEach(blog => {
        (blog as HTMLElement).style.display = 'none';
      });
      
      // Show all filtered blogs
      this.filteredBlogs.forEach(blog => {
        (blog as HTMLElement).style.display = 'block';
      });
      
      // Show no blogs message if needed
      if (this.filteredBlogs.length === 0) {
        this.showNoBlogsMessage();
      } else {
        this.hideNoBlogsMessage();
      }
    }


    hideAllBlogs(): void {
      this.allBlogs.forEach(blog => {
        const blogElement = blog as HTMLElement;
        blogElement.style.display = 'none';
        
        // Clear all animation classes
        blogElement.classList.remove('animating', 'animating-in', 'animating-out', 'hidden', 'fade-out', 'fade-in', 'domino-in');
      });
    }


    updatePaginationUI(): void {
      const currentPageEl = document.getElementById('current-page');
      const totalPagesEl = document.getElementById('total-pages');
      const totalItemsEl = document.getElementById('total-items');
      const prevBtn = document.getElementById('prev-page') as HTMLButtonElement;
      const nextBtn = document.getElementById('next-page') as HTMLButtonElement;
      
      if (currentPageEl) currentPageEl.textContent = this.currentPage.toString();
      if (totalPagesEl) totalPagesEl.textContent = this.totalPages.toString();
      if (totalItemsEl) totalItemsEl.textContent = this.filteredBlogs.length.toString();
      
      // Update button states
      if (prevBtn) prevBtn.disabled = this.currentPage === 1;
      if (nextBtn) nextBtn.disabled = this.currentPage === this.totalPages;
      
    }


    previousPage(): void {
      if (this.currentPage > 1) {
        this.showPage(this.currentPage - 1);
      }
    }

    nextPage(): void {
      if (this.currentPage < this.totalPages) {
        this.showPage(this.currentPage + 1);
      }
    }

    showNoBlogsMessage(): void {
      const blogGrid = document.querySelector('.blog-grid');
      if (!blogGrid) return;

      this.hideNoBlogsMessage();
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'no-blogs-message';
      messageDiv.innerHTML = `
        <div class="no-blogs-content">
          <h3>表示するブログがありません</h3>
          <p>「${this.currentCategory === 'all' ? 'All' : this.currentCategory}」カテゴリーにはまだブログが投稿されていません。</p>
        </div>
      `;
      
      blogGrid.appendChild(messageDiv);
    }

    hideNoBlogsMessage(): void {
      const blogGrid = document.querySelector('.blog-grid');
      if (!blogGrid) return;
      
      const existingMessage = blogGrid.querySelector('.no-blogs-message');
      if (existingMessage) {
        existingMessage.remove();
      }
    }
  }


  // Initialize pagination when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    (window as any).blogPagination = new BlogPagination();
    
    // Handle window resize
    window.addEventListener('resize', () => {
      if (window.blogPagination) {
        const pagination = window.blogPagination as any;
        const wasMobile = pagination.isMobile;
        pagination.isMobile = window.innerWidth <= 767;
        
        // If mobile state changed, reinitialize display
        if (wasMobile !== pagination.isMobile) {
          if (pagination.isMobile) {
            pagination.showAllBlogs();
          } else {
            pagination.showPage(1);
          }
        }
      }
    });
  });
</script>

