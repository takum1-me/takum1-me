---
import Layout from "../layouts/Layout.astro";
import PageTitle from "../components/shared/page/PageTitle";
import PageContainer from "../components/shared/page/PageContainer";
import Card, { CardHeader } from "../components/shared/card/Card";
import AboutSnsLinks from "../components/features/about/AboutSnsLinks";
import CoffeeFlavorTag from "../components/features/coffee/CoffeeFlavorTag";
import { aboutData } from "../data/about";
import { getAllAbout, type AboutItem } from "../lib/microcms";
import "../components/shared/page/page-title.css";
import "../components/shared/page/page-container.css";
import "../components/shared/card/card.css";
import "../components/features/about/about-sns-links.css";
import "../components/features/coffee/coffee-flavor-tag.css";

// microCMSからデータを取得
let aboutItems: AboutItem[] = [];
try {
  const response = await getAllAbout();
  aboutItems = response.contents;
} catch (error) {
  // 環境変数が設定されていない場合は空配列を使用
  console.error("Failed to fetch about data:", error);
}

// genreで分類
const favoriteItems = aboutItems.filter(item => item.genre.includes("favorite-item"));
const favoriteCoffees = aboutItems.filter(item => item.genre.includes("favorite-coffee"));
const favoriteFlavors = aboutItems.filter(item => item.genre.includes("favorite-flavor"));
const interests = aboutItems.filter(item => item.genre.includes("interest"));
const organizations = aboutItems.filter(item => item.genre.includes("organization"));
const certifications = aboutItems.filter(item => item.genre.includes("certification"));

// 日付フォーマット関数
const formatDate = (dateString: string): string => {
  const date = new Date(dateString);
  const year = date.getFullYear();
  const month = date.getMonth() + 1;
  return `${year}年${month}月`;
};

const formatPeriod = (beginDate?: string, finishDate?: string): string => {
  if (!beginDate) return "";
  const begin = formatDate(beginDate);
  if (finishDate) {
    const finish = formatDate(finishDate);
    return `${begin}〜${finish}`;
  }
  return `${begin}〜`;
};

const formatRolePeriod = (specificBeginDate?: string, specificFinishDate?: string): string => {
  if (!specificBeginDate) return "";
  const begin = formatDate(specificBeginDate);
  if (specificFinishDate) {
    const finish = formatDate(specificFinishDate);
    return `${begin}〜${finish}`;
  }
  return `${begin}〜`;
};
---

<Layout title="About">
    <PageContainer variant="about">
        <PageTitle title="ABOUT" pageType="about" client:load />
        <div class="content-grid">
            <Card variant="interests">
                <CardHeader>
                    <h2>趣味・関心</h2>
                </CardHeader>
                
                <div class="coffee-section">
                    <h3>{aboutData.coffee.title}</h3>
                    <p class="coffee-description">
                        {aboutData.coffee.description}
                    </p>
                    
                    <div class="coffee-equipment">
                        <h4>使用器具</h4>
                        <div class="equipment-tags">
                            {favoriteItems.length > 0 ? (
                                favoriteItems.map(item => (
                                    <span class="equipment-tag">{item.title}</span>
                                ))
                            ) : (
                                aboutData.coffee.equipment.map(equipment => (
                                    <span class="equipment-tag">{equipment.name}</span>
                                ))
                            )}
                        </div>
                    </div>

                    <div class="coffee-preferences">
                        <h4>お気に入りの産地・品種</h4>
                        <div class="preference-tags">
                            {favoriteCoffees.length > 0 ? (
                                favoriteCoffees.map(item => (
                                    <span class="preference-tag">{item.title}</span>
                                ))
                            ) : (
                                aboutData.coffee.preferences.map(preference => (
                                    <span class="preference-tag">{preference.name}</span>
                                ))
                            )}
                        </div>
                    </div>

                    <div class="coffee-flavors">
                        <h4>好きなフレーバー</h4>
                        <div class="flavor-tags-container">
                            {favoriteFlavors.length > 0 ? (
                                favoriteFlavors.map(item => (
                                    <CoffeeFlavorTag flavorName={item.title} client:load />
                                ))
                            ) : (
                                aboutData.coffee.favoriteFlavors.map(flavor => (
                                    <CoffeeFlavorTag flavorName={flavor.name} client:load />
                                ))
                            )}
                        </div>
                    </div>
                </div>

                <div class="other-interests">
                    <h3>{aboutData.otherInterests.title}</h3>
                    <div class="interest-tags">
                        {interests.length > 0 ? (
                            interests.map(item => (
                                <span class="interest-tag">{item.title}</span>
                            ))
                        ) : (
                            aboutData.otherInterests.interests.map(interest => (
                                <span class="interest-tag">{interest.name}</span>
                            ))
                        )}
                    </div>
                </div>
            </Card>

            <Card variant="organizations">
                <CardHeader>
                    <h2>所属</h2>
                </CardHeader>
                <div class="organizations-list">
                    {organizations.map(organization => (
                        <div class="organization-item">
                            <h3>
                                {organization.link ? (
                                    <a href={organization.link} target="_blank" rel="noopener noreferrer">
                                        <span>{organization.title}</span>
                                    </a>
                                ) : (
                                    <span>{organization.title}</span>
                                )}
                            </h3>
                            {organization.beginDate && (
                                <span class="organization-period">
                                    {formatPeriod(organization.beginDate, organization.finishDate)}
                                </span>
                            )}
                            {organization.specific && (
                                <div class="role">
                                    {organization.specific}
                                    {organization.specificBeiginDate && (
                                        `（${formatRolePeriod(organization.specificBeiginDate, organization.specificFinishDate)}）`
                                    )}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </Card>

            <Card variant="qualifications">
                <CardHeader>
                    <h2>資格</h2>
                </CardHeader>
                <div class="qualifications-list">
                    {certifications.map(certification => (
                        <div class="qualification-item">
                            <span class="qualification-name">{certification.title}</span>
                            {certification.beginDate && (
                                <span class="qualification-date">{formatDate(certification.beginDate)}</span>
                            )}
                        </div>
                    ))}
                </div>
            </Card>
        </div>

        <AboutSnsLinks client:load />
    </PageContainer>
</Layout>

<style>
    .content-grid {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        margin-top: 2rem;
    }

    .qualifications-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(17.5rem, 1fr));
        gap: 1rem;
    }

    .qualification-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem;
        background: transparent;
        border-radius: 0.5rem;
        border-left: 3px solid var(--color-primary);
        border-bottom: 1px solid #e2e8f0;
    }

    .qualification-name {
        font-weight: 600;
        color: #1e293b;
    }

    .qualification-date {
        color: var(--color-primary);
        font-size: 0.9rem;
        font-weight: 500;
        padding: 0.25rem 0;
    }

    .organizations-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(18.75rem, 1fr));
        gap: 1.5rem;
    }

    .organization-item {
        padding: 1.5rem;
        background: transparent;
        border-radius: 0.5rem;
        border-left: 3px solid var(--color-primary);
        border-bottom: 1px solid #e2e8f0;
    }

    .organization-item h3 {
        margin: 0 0 0.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
    }

    .organization-item h3 a {
        color: #1e293b;
        text-decoration: none;
        display: inline-block;
        padding: 0.25rem 0.5rem;
        margin-left: -0.5rem;
        border-radius: 0.25rem;
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        background: transparent;
    }

    .organization-item h3 a::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 0;
        height: 100%;
        background: var(--color-primary);
        transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 0;
    }

    .organization-item h3 a span {
        position: relative;
        z-index: 1;
        transition: color 0.3s ease;
    }

    .organization-item h3 a:hover {
        color: #fff;
    }

    .organization-item h3 a:hover span {
        color: #fff;
    }

    .organization-item h3 a:hover::before {
        width: 100%;
    }

    .organization-period {
        color: var(--color-primary);
        font-size: 0.9rem;
        font-weight: 500;
        display: inline-block;
        margin-bottom: 0.5rem;
    }

    .role {
        color: var(--color-primary);
        font-weight: 500;
        font-size: 0.9rem;
        background: var(--color-primary-10);
        padding: 0.25rem 0.75rem;
        border-radius: 1.25rem;
        display: inline-block;
    }

    .coffee-section {
        margin-bottom: 2rem;
    }

    .coffee-section h3 {
        color: var(--color-primary);
        margin: 0 0 1rem;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .coffee-description {
        color: var(--color-muted);
        line-height: 1.6;
        margin-bottom: 1.5rem;
    }

    .coffee-equipment,
    .coffee-preferences,
    .coffee-flavors {
        margin-bottom: 1.5rem;
    }

    .coffee-equipment h4,
    .coffee-preferences h4,
    .coffee-flavors h4 {
        margin: 0 0 0.75rem;
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text-primary);
    }

    .equipment-tags,
    .preference-tags,
    .flavor-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .equipment-tag,
    .preference-tag {
        background: transparent;
        color: var(--color-text-primary);
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
        font-weight: 500;
        border: 2px solid #e2e8f0;
    }

    .preference-tag {
        background: transparent;
        color: var(--color-primary);
        border-color: #d4c4a8;
    }

    .other-interests h3 {
        color: var(--color-primary);
        margin: 0 0 1rem;
        font-size: 1.3rem;
        font-weight: 600;
    }

    .interest-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .interest-tag {
        background: transparent;
        color: #475569;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.9rem;
        font-weight: 500;
        border: 2px solid #e2e8f0;
    }

    @media (width <= 48rem) {
        .content-grid {
            gap: 1.5rem;
        }
        
        .qualifications-list {
            grid-template-columns: 1fr;
        }
        
        .organizations-list {
            grid-template-columns: 1fr;
        }
        
        .qualification-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .equipment-tags,
        .preference-tags,
        .interest-tags,
        .flavor-tags-container {
            justify-content: center;
        }
    }
</style>

